#!/bin/sh
#
# commit-msg hook to add version number to commit message
# This gets called after the user enters a commit message but before the commit is finalized

COMMIT_MSG_FILE=$1
PROJECT_ROOT=$(git rev-parse --show-toplevel)
VERSION_FILE="$PROJECT_ROOT/client/src/version.json"

# Check if commit already has version prefix
if grep -q "^v[0-9]\+\.[0-9]\+\.[0-9]\+:" "$COMMIT_MSG_FILE"; then
  exit 0
fi

# Get version from version.json
if [ -f "$VERSION_FILE" ]; then
  VERSION=$(grep -o '"version": *"[^"]*"' "$VERSION_FILE" | sed 's/"version": *"\([^"]*\)"/\1/')
  
  if [ -n "$VERSION" ]; then
    # Read current commit message
    CURRENT_MSG=$(cat "$COMMIT_MSG_FILE")
    
    # Create new message with version prefix
    NEW_MSG="v$VERSION: $CURRENT_MSG"
    
    # Write new message back to commit message file
    echo "$NEW_MSG" > "$COMMIT_MSG_FILE"
    
    echo "$(date): commit-msg hook added version v$VERSION" > "/tmp/git-commit-msg-hook.log"
  fi
fi

exit 0
